Option Explicit

'===========================
' MAIN MACRO
'===========================
Sub BuildSignalTemplate()

    ' Source sheet (your existing sheet that contains the data)
    ' Output sheet (the sheet you want generated/updated)
    Dim wsW As Worksheet, wsR As Worksheet
    Dim lastRow As Long, r As Long, outRow As Long
    Dim dict As Object
    Dim sig As String, inter As String
    Dim firstRowForSig As Long

    ' ---- CHANGE SHEET NAMES HERE (already set to your names) ----
    Set wsW = ThisWorkbook.Worksheets("Kens example")
    Set wsR = ThisWorkbook.Worksheets("NewTemplate")

    ' Safety checks (helps avoid "Subscript out of range" confusion)
    If wsW Is Nothing Then
        MsgBox "Sheet not found: Kens example", vbCritical
        Exit Sub
    End If
    If wsR Is Nothing Then
        MsgBox "Sheet not found: NewTemplate", vbCritical
        Exit Sub
    End If

    Set dict = CreateObject("Scripting.Dictionary")

    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.EnableEvents = False

    ' Clear old output
    wsR.Cells.Clear

    ' Headers A:S (matches your full set through SBR)
    wsR.Range("A1:S1").Value = Array( _
        "ID", "Intersection", "Calibration #", "Date", "Time of Day", _
        "Total", "EB Total", "WB Total", "NB Total", "SB Total", _
        "EBL", "EBT", "EBR", _
        "NBL", "NBT", "NBR", _
        "SBL", "SBT", "SBR")

    ' Find last used row in source (Column A = ID)
    lastRow = wsW.Cells(wsW.Rows.Count, "A").End(xlUp).Row
    If lastRow < 2 Then
        MsgBox "No data found on 'Kens example' (need headers + at least 1 data row).", vbExclamation
        GoTo CleanExit
    End If

    ' Collect unique Signal IDs in the order they appear
    ' (skips blank IDs)
    For r = 2 To lastRow
        sig = Trim$(CStr(wsW.Cells(r, "A").Value))
        If Len(sig) > 0 Then
            If Not dict.Exists(sig) Then
                dict.Add sig, r ' store first row index for that signal
            End If
        End If
    Next r

    outRow = 2

    ' Build blocks
    Dim key As Variant
    For Each key In dict.Keys

        sig = CStr(key)
        firstRowForSig = CLng(dict(key))
        inter = CStr(wsW.Cells(firstRowForSig, "B").Value)

        ' Insert 4 rows for this signal (Manual/Vision/%Diff/GEH)
        wsR.Rows(outRow & ":" & outRow + 3).Insert Shift:=xlDown

        ' Merge A and B ONLY across 4 rows
        With wsR
            .Range(.Cells(outRow, "A"), .Cells(outRow + 3, "A")).Merge
            .Range(.Cells(outRow, "B"), .Cells(outRow + 3, "B")).Merge

            .Cells(outRow, "A").Value = sig
            .Cells(outRow, "B").Value = inter

            ' Fixed row labels in Column C
            .Cells(outRow, "C").Value = "Manual"
            .Cells(outRow + 1, "C").Value = "Vision"
            .Cells(outRow + 2, "C").Value = "% Difference"
            .Cells(outRow + 3, "C").Value = "GEH"
        End With

        ' Format A:B like your example (black bg, white bold, vertically centered)
        With wsR.Range(wsR.Cells(outRow, "A"), wsR.Cells(outRow + 3, "B"))
            .Interior.Color = vbBlack
            .Font.Color = vbWhite
            .Font.Bold = True
            .VerticalAlignment = xlCenter
            .HorizontalAlignment = xlLeft
            .WrapText = True
        End With

        ' Fill the data rows for this signal from Kens example into the correct slots
        FillSignalData wsW, wsR, sig, outRow, lastRow

        ' Optional borders (nice visual blocks)
        With wsR.Range(wsR.Cells(outRow, "A"), wsR.Cells(outRow + 3, "S"))
            .Borders.LineStyle = xlContinuous
            .Borders.Weight = xlThin
            .BorderAround LineStyle:=xlContinuous, Weight:=xlMedium
        End With

        outRow = outRow + 4
    Next key

    ' Light formatting for header row
    With wsR.Range("A1:S1")
        .Font.Bold = True
        .VerticalAlignment = xlCenter
        .WrapText = True
    End With

    wsR.Columns("A:S").AutoFit

CleanExit:
    Application.EnableEvents = True
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True

End Sub

'===========================
' HELPERS
'===========================
Private Sub FillSignalData(wsW As Worksheet, wsR As Worksheet, sig As String, outRow As Long, lastRow As Long)

    ' Copies source columns D:S (Date..SBR) into the correct output row,
    ' based on Calibration label in source column C.
    '
    ' Source mapping assumptions on "Kens example":
    ' A = ID
    ' B = Intersection
    ' C = Calibration #  (Manual/Vision/% Difference/GEH)
    ' D:S = Date..SBR (16 columns)

    Dim r As Long
    Dim cal As String
    Dim targetRow As Long

    For r = 2 To lastRow

        If Trim$(CStr(wsW.Cells(r, "A").Value)) = sig Then

            cal = LCase$(Trim$(CStr(wsW.Cells(r, "C").Value)))
            targetRow = 0

            Select Case cal
                Case "manual"
                    targetRow = outRow
                Case "vision"
                    targetRow = outRow + 1
                Case "% difference", "%difference", "percent difference"
                    targetRow = outRow + 2
                Case "geh"
                    targetRow = outRow + 3
                Case Else
                    ' If you have other labels you want to map, add them here.
                    targetRow = 0
            End Select

            If targetRow > 0 Then
                ' Copy D:S (16 columns) from source to output
                wsR.Cells(targetRow, "D").Resize(1, 16).Value = wsW.Cells(r, "D").Resize(1, 16).Value
            End If

        End If

    Next r

End Sub
