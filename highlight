Option Explicit

Sub Apply_GEH_and_PercentDiff_Formatting()

    Dim ws As Worksheet
    Set ws = ActiveSheet   ' or ThisWorkbook.Worksheets("Data")

    '=== SETTINGS YOU MAY CHANGE ===
    Dim labelCol As Long: labelCol = 2   ' Column B holds labels: Manual, Vision, % Difference, GEH
    Dim firstValueCol As Long: firstValueCol = 6 ' Column F where numbers start (Total). Adjust if needed.
    '================================

    Dim lastRow As Long, lastCol As Long
    lastRow = ws.Cells(ws.Rows.Count, labelCol).End(xlUp).Row
    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column

    Dim r As Long
    Dim rng As Range

    Application.ScreenUpdating = False

    For r = 1 To lastRow

        Dim labelText As String
        labelText = Trim$(CStr(ws.Cells(r, labelCol).Value))

        ' Range of numeric cells on this row (F to last used column)
        If lastCol >= firstValueCol Then
            Set rng = ws.Range(ws.Cells(r, firstValueCol), ws.Cells(r, lastCol))
        Else
            GoTo NextRow
        End If

        '----- % Difference formatting -----
        If LCase$(labelText) = "% difference" Or LCase$(labelText) = "percent difference" Then

            ' Clear old conditional formatting
            rng.FormatConditions.Delete

            ' Green: ABS(x) <= 5
            With rng.FormatConditions.Add(Type:=xlExpression, Formula1:="=ABS(" & rng.Cells(1, 1).Address(False, False) & ")<=5")
                .Interior.Color = RGB(198, 239, 206)
                .Font.Color = RGB(0, 97, 0)
            End With

            ' Yellow: 5 < ABS(x) <= 10
            With rng.FormatConditions.Add(Type:=xlExpression, Formula1:="=AND(ABS(" & rng.Cells(1, 1).Address(False, False) & ")>5,ABS(" & rng.Cells(1, 1).Address(False, False) & ")<=10)")
                .Interior.Color = RGB(255, 235, 156)
                .Font.Color = RGB(156, 101, 0)
            End With

            ' Red: ABS(x) > 10
            With rng.FormatConditions.Add(Type:=xlExpression, Formula1:="=ABS(" & rng.Cells(1, 1).Address(False, False) & ")>10")
                .Interior.Color = RGB(255, 199, 206)
                .Font.Color = RGB(156, 0, 6)
            End With

        End If

        '----- GEH formatting -----
        If LCase$(labelText) = "geh" Then

            rng.FormatConditions.Delete

            ' Green: < 1
            With rng.FormatConditions.Add(Type:=xlExpression, Formula1:="=" & rng.Cells(1, 1).Address(False, False) & "<1")
                .Interior.Color = RGB(198, 239, 206)
                .Font.Color = RGB(0, 97, 0)
            End With

            ' Red: >= 1
            With rng.FormatConditions.Add(Type:=xlExpression, Formula1:="=" & rng.Cells(1, 1).Address(False, False) & ">=1")
                .Interior.Color = RGB(255, 199, 206)
                .Font.Color = RGB(156, 0, 6)
            End With

        End If

NextRow:
    Next r

    Application.ScreenUpdating = True

    MsgBox "Conditional formatting applied to % Difference and GEH rows.", vbInformation

End Sub
